<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ashby Job Checker (Validated)</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .header {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            position: sticky;
            top: 0;
            background: #0a0a0a;
            padding: 15px 0;
            z-index: 500;
            border-bottom: 1px solid #222;
        }
        .header h1 { font-size: 20px; margin: 0; margin-right: 20px; }
        .filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
            width: 100%;
        }
        .filters button {
            padding: 6px 12px;
            font-size: 12px;
            background: #222;
            border: 1px solid #333;
        }
        .filters button:hover { background: #333; }
        .filters button.active { background: #4a9eff; border-color: #4a9eff; }
        input[type="file"] {
            padding: 10px;
            font-size: 13px;
            border: 2px dashed #333;
            border-radius: 6px;
            background: #111;
            color: #888;
            cursor: pointer;
        }
        input[type="file"]:hover { border-color: #555; }
        input[type="text"] {
            padding: 12px 16px;
            font-size: 14px;
            border: 2px solid #333;
            border-radius: 6px;
            background: #111;
            color: #fff;
            outline: none;
            width: 200px;
        }
        input[type="text"]:focus { border-color: #4a9eff; }
        input[type="text"]::placeholder { color: #555; }
        button {
            padding: 12px 24px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            background: #4a9eff;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }
        button:hover { background: #3a8eef; }
        .stats { font-size: 13px; color: #666; }
        .stats span { color: #4ade80; font-weight: 600; }
        .stats .valid-count { color: #4a9eff; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 8px;
        }
        .grid a {
            display: block;
            padding: 14px 12px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            color: #fff;
            text-decoration: none;
            font-size: 13px;
            text-align: center;
            transition: all 0.15s ease;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .grid a:hover { background: #252525; border-color: #4a9eff; }
        .grid a.clicked {
            background: #0d2a1a;
            border-color: #166534;
            color: #4ade80;
            opacity: 0.6;
        }
        .grid a.clicked::after { content: ' ‚úì'; }
        .grid a.applied-ashby { background: #1a1a2e; border-color: #4a9eff; color: #4a9eff; }
        .grid a.applied-ashby::after { content: ' ‚úì ASHBY'; font-size: 10px; font-weight: 700; }
        .grid a.applied-linkedin { background: #1a1a2e; border-color: #0a66c2; color: #5094d4; }
        .grid a.applied-linkedin::after { content: ' ‚úì LINKEDIN'; font-size: 10px; font-weight: 700; }
        .grid a.applied-yc { background: #2a1a0a; border-color: #f26625; color: #f59563; }
        .grid a.applied-yc::after { content: ' ‚úì YC'; font-size: 10px; font-weight: 700; }
        .grid a.applied-email { background: #1a2a1a; border-color: #22c55e; color: #4ade80; }
        .grid a.applied-email::after { content: ' ‚úì EMAIL'; font-size: 10px; font-weight: 700; }
        .grid a.applied-website { background: #2a1a2a; border-color: #a855f7; color: #c084fc; }
        .grid a.applied-website::after { content: ' ‚úì WEBSITE'; font-size: 10px; font-weight: 700; }
        .grid a.passed { background: #2a1a1a; border-color: #dc2626; color: #f87171; opacity: 0.5; }
        .grid a.passed::after { content: ' ‚úó PASSED'; font-size: 10px; font-weight: 700; }
        .grid a.not-qualified { background: #2a2a1a; border-color: #ca8a04; color: #facc15; opacity: 0.5; }
        .grid a.not-qualified::after { content: ' ‚úó NOT QUALIFIED'; font-size: 10px; font-weight: 700; }
        .grid a.no-jobs { background: #1a1a1a; border-color: #555; color: #666; opacity: 0.4; }
        .grid a.no-jobs::after { content: ' ‚Äî NO JOBS'; font-size: 10px; font-weight: 700; }
        .grid a.interviewing { background: #1a2e1a; border-color: #22c55e; color: #4ade80; }
        .grid a.interviewing::after { content: ' ‚òÖ INTERVIEWING'; font-size: 10px; font-weight: 700; }
        .grid a.failed-interview { background: #2a1a2a; border-color: #9333ea; color: #a855f7; opacity: 0.5; }
        .grid a.failed-interview::after { content: ' ‚úó FAILED INTERVIEW'; font-size: 10px; font-weight: 700; }
        .grid a.not-in-us { background: #1a1a1a; border-color: #065f46; color: #34d399; opacity: 0.4; }
        .grid a.not-in-us::after { content: ' üåç NOT IN US'; font-size: 10px; font-weight: 700; }
        .context-menu {
            position: fixed;
            background: #222;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 6px 0;
            z-index: 1000;
            min-width: 160px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .context-menu div { padding: 10px 16px; cursor: pointer; font-size: 13px; color: #fff; }
        .context-menu div:hover { background: #333; }
        .context-menu div.clear-status { border-top: 1px solid #444; margin-top: 6px; padding-top: 12px; color: #888; }
        .context-menu div.close-menu { color: #666; font-size: 12px; text-align: center; }
        .empty { color: #444; text-align: center; padding: 60px 20px; font-size: 14px; }
        .clear-btn { background: #333; margin-left: 10px; }
        .clear-btn:hover { background: #444; }
        .export-btn { background: #22c55e; }
        .export-btn:hover { background: #16a34a; }
        .loading { color: #4a9eff; text-align: center; padding: 60px 20px; }

        /* Auth styles */
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: #0a0a0a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .auth-box {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 40px;
            width: 100%;
            max-width: 360px;
        }
        .auth-box h2 {
            margin: 0 0 24px 0;
            font-size: 20px;
            text-align: center;
        }
        .auth-box input {
            width: 100%;
            padding: 12px 16px;
            font-size: 14px;
            border: 2px solid #333;
            border-radius: 6px;
            background: #111;
            color: #fff;
            outline: none;
            margin-bottom: 12px;
        }
        .auth-box input:focus { border-color: #4a9eff; }
        .auth-box button {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
        }
        .auth-error {
            color: #f87171;
            font-size: 13px;
            text-align: center;
            margin-top: 12px;
        }
        .logout-btn {
            background: #333;
            padding: 8px 16px;
            font-size: 12px;
        }
        .logout-btn:hover { background: #444; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Auth Overlay -->
    <div class="auth-overlay" id="auth-overlay">
        <div class="auth-box">
            <h2>Login Required</h2>
            <input type="email" id="auth-email" placeholder="Email">
            <input type="password" id="auth-password" placeholder="Password">
            <button id="auth-submit">Login</button>
            <div class="auth-error" id="auth-error"></div>
        </div>
    </div>

    <div class="header" id="main-header" style="display: none;">
        <h1>Ashby Checker ‚úì</h1>
        <input type="file" id="csv-file" accept=".csv,.txt">
        <button id="generate">Generate Grid</button>
        <input type="text" id="search" placeholder="Search companies...">
        <button id="export" class="export-btn">Export CSV</button>
        <button id="clear" class="clear-btn">Clear Clicked</button>
        <button id="logout" class="logout-btn">Logout</button>
        <div class="stats">
            Visited: <span id="clicked-count">0</span> | 
            Applied: <span id="applied-count">0</span> | 
            Total: <span id="total-count" class="valid-count">0</span> (validated)
        </div>
        <div class="filters">
            <button data-filter="all" class="active">All</button>
            <button data-filter="unvisited">Unvisited</button>
            <button data-filter="clicked">Visited</button>
            <button data-filter="applied">Applied (All)</button>
            <button data-filter="interviewing">Interviewing</button>
            <button data-filter="failed-interview">Failed Interview</button>
            <button data-filter="passed">Passed</button>
            <button data-filter="not-qualified">Not Qualified</button>
            <button data-filter="no-jobs">No Jobs</button>
            <button data-filter="not-in-us">Not in US</button>
        </div>
    </div>
    
    <div class="grid" id="grid" style="display: none;">
        <div class="loading">Upload ashby-valid.csv to load validated companies...</div>
    </div>

    <script>
        // Supabase Auth Setup
        const SUPABASE_URL = 'https://ampsliudevabkybsbqil.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtcHNsaXVkZXZhYmt5YnNicWlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMjE4MTIsImV4cCI6MjA4MTg5NzgxMn0.iZFMR_NheMnFajb_TiW-Gy2dXHgsLpmIgpgJV20RCiM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const authOverlay = document.getElementById('auth-overlay');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authSubmit = document.getElementById('auth-submit');
        const authError = document.getElementById('auth-error');
        const mainHeader = document.getElementById('main-header');
        const logoutBtn = document.getElementById('logout');

        function showApp() {
            authOverlay.style.display = 'none';
            mainHeader.style.display = 'flex';
            document.getElementById('grid').style.display = 'grid';
        }

        function showLogin() {
            authOverlay.style.display = 'flex';
            mainHeader.style.display = 'none';
            document.getElementById('grid').style.display = 'none';
        }

        // Check for existing session on load
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                showApp();
            } else {
                showLogin();
            }
        });

        // Listen for auth changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                showApp();
            } else {
                showLogin();
            }
        });

        // Login handler
        authSubmit.addEventListener('click', async () => {
            authError.textContent = '';
            const email = authEmail.value.trim();
            const password = authPassword.value;

            if (!email || !password) {
                authError.textContent = 'Please enter email and password';
                return;
            }

            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                authError.textContent = error.message;
            }
        });

        // Enter key to submit
        authPassword.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') authSubmit.click();
        });

        // Logout handler
        logoutBtn.addEventListener('click', async () => {
            await supabase.auth.signOut();
        });
    </script>

    <script>
        const csvFile       = document.getElementById('csv-file');
        const generateBtn   = document.getElementById('generate');
        const clearBtn      = document.getElementById('clear');
        const exportBtn     = document.getElementById('export');
        const searchInput   = document.getElementById('search');
        const grid          = document.getElementById('grid');
        const clickedCount  = document.getElementById('clicked-count');
        const appliedCount  = document.getElementById('applied-count');
        const totalCount    = document.getElementById('total-count');
        const filterBtns    = document.querySelectorAll('.filters button');

        let companyNames        = [];
        let currentFilter       = 'all';
        let clicked             = new Set();
        let statuses            = {};
        let currentContextLink  = null;

        const allStatuses = [
            'applied-ashby','applied-linkedin','applied-yc','applied-email','applied-website', 
            'interviewing' ,'failed-interview','passed'    ,'not-qualified','no-jobs'
            ,'not-in-us'
        ];

        const contextMenu = document.createElement('div');
        contextMenu.className = 'context-menu';
        contextMenu.style.display = 'none';
        // TODO: consider making the righ click menu context dynamic at some point 
        contextMenu.innerHTML = `
            <div data-status="applied-ashby">‚úì Applied - Ashby</div>
            <div data-status="applied-linkedin">‚úì Applied - LinkedIn</div>
            <div data-status="applied-yc">‚úì Applied - YC</div>
            <div data-status="applied-email">‚úì Applied - Email</div>
            <div data-status="applied-website">‚úì Applied - Website</div>
            <div data-status="interviewing">‚òÖ Interviewing</div>
            <div data-status="failed-interview">‚úó Failed Interview</div>
            <div data-status="passed">‚úó Passed</div>
            <div data-status="not-qualified">‚úó Not Qualified</div>
            <div data-status="no-jobs">‚Äî No Jobs</div>
            <div data-status="not-in-us">üåç Not in US</div>
            <div class="clear-status" data-status="clear">Clear Status</div>
            <div class="close-menu" data-status="close">‚úï Close</div>
        `;
        document.body.appendChild(contextMenu);

        document.addEventListener('click', () => contextMenu.style.display = 'none');
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') contextMenu.style.display = 'none'; });

        filterBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                filterBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                applyFilters();
            });
        });

        function applyFilters() {
            const query = searchInput.value.toLowerCase().trim();
            const links = grid.querySelectorAll('a');
            
            links.forEach(link => {
                const name = link.textContent.toLowerCase();
                const formatted = link.dataset.formatted;
                const status = statuses[formatted] || (clicked.has(formatted) ? 'clicked' : 'unvisited');
                
                let matchesFilter = currentFilter === 'all' || 
                    (currentFilter === 'applied' ? status.startsWith('applied') : status === currentFilter);
                let matchesSearch = query === '' || name.includes(query);
                
                link.style.display = (matchesFilter && matchesSearch) ? 'block' : 'none';
            });
        }

        contextMenu.addEventListener('click', function(e) {
            const status = e.target.dataset.status;
            if (!status || !currentContextLink) return;
            if (status === 'close') { contextMenu.style.display = 'none'; return; }

            const formatted = currentContextLink.dataset.formatted;
            allStatuses.forEach(s => currentContextLink.classList.remove(s));
            currentContextLink.classList.remove('clicked');

            if (status === 'clear') {
                delete statuses[formatted];
                clicked.delete(formatted);
            } else {
                statuses[formatted] = status;
                currentContextLink.classList.add(status);
            }

            saveStatuses();
            updateStats();
            contextMenu.style.display = 'none';
        });

        function formatCompanyName(name) {
            return name.trim().toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '').replace(/-+/g, '');
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const names = [];
            
            // Skip header if present
            const startIndex = lines[0]?.toLowerCase().includes('company') ? 1 : 0;
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                
                // Handle quoted CSV: "Company Name","URL"
                const match = line.match(/^"([^"]+)"/);
                if (match) {
                    names.push(match[1]);
                } else {
                    const cells = line.split(/[,\t]/);
                    const cleaned = cells[0]?.trim().replace(/^["']|["']$/g, '');
                    if (cleaned && cleaned.length > 1) {
                        names.push(cleaned);
                    }
                }
            }
            
            return [...new Set(names)];
        }

        csvFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                companyNames = parseCSV(e.target.result);
                generateBtn.click();
            };
            reader.readAsText(file);
        });

        function updateStats() {
            clickedCount.textContent = clicked.size;
            appliedCount.textContent = Object.values(statuses).filter(s => s.startsWith('applied')).length;
        }

        function saveClicked() { localStorage.setItem('ashby-clicked-v2', JSON.stringify([...clicked])); }
        function loadClicked() { try { const s = localStorage.getItem('ashby-clicked-v2'); if (s) clicked = new Set(JSON.parse(s)); } catch(e){} }
        function saveStatuses() { localStorage.setItem('ashby-statuses-v2', JSON.stringify(statuses)); }
        function loadStatuses() { try { const s = localStorage.getItem('ashby-statuses-v2'); if (s) statuses = JSON.parse(s); } catch(e){} }

        generateBtn.addEventListener('click', function() {
            if (companyNames.length === 0) {
                grid.innerHTML = '<div class="empty">No companies loaded. Upload ashby-valid.csv</div>';
                totalCount.textContent = '0';
                return;
            }

            grid.innerHTML = '';
            totalCount.textContent = companyNames.length;

            companyNames.forEach(name => {
                const formatted = formatCompanyName(name);
                const url = `https://jobs.ashbyhq.com/${formatted}`;

                const link = document.createElement('a');
                link.href = url;
                link.target = '_blank';
                link.textContent = name;
                link.dataset.formatted = formatted;

                if (clicked.has(formatted)) link.classList.add('clicked');
                if (statuses[formatted]) {
                    link.classList.remove('clicked');
                    link.classList.add(statuses[formatted]);
                }

                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.open(url, '_blank', 'noopener');
                    if (!statuses[formatted]) {
                        this.classList.add('clicked');
                        clicked.add(formatted);
                        updateStats();
                        saveClicked();
                    }
                });

                link.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    currentContextLink = this;
                    contextMenu.style.display = 'block';
                    const x = Math.min(e.clientX, window.innerWidth - contextMenu.offsetWidth - 10);
                    const y = Math.min(e.clientY, window.innerHeight - contextMenu.offsetHeight - 10);
                    contextMenu.style.left = x + 'px';
                    contextMenu.style.top = y + 'px';
                });

                grid.appendChild(link);
            });

            updateStats();
            applyFilters();
        });

        clearBtn.addEventListener('click', function() {
            if (confirm('Clear all clicked states?')) {
                clicked.clear();
                document.querySelectorAll('.grid a.clicked').forEach(a => a.classList.remove('clicked'));
                updateStats();
                saveClicked();
            }
        });

        searchInput.addEventListener('input', applyFilters);

        exportBtn.addEventListener('click', function() {
            const links = grid.querySelectorAll('a');
            if (links.length === 0) { alert('Generate grid first'); return; }

            const statusLabels = {
                'applied-ashby': 'Applied - Ashby',
                'applied-linkedin': 'Applied - LinkedIn',
                'applied-yc': 'Applied - YC',
                'applied-email': 'Applied - Email',
                'applied-website': 'Applied - Website',
                'interviewing': 'Interviewing',
                'failed-interview': 'Failed Interview',
                'passed': 'Passed',
                'not-qualified': 'Not Qualified',
                'no-jobs': 'No Jobs',
                'not-in-us': 'Not in US'
            };

            let csv = 'Company,Ashby URL,Status\n';
            links.forEach(link => {
                const name = link.textContent.replace(/[‚úì‚úó‚òÖ‚Äî].*$/, '').trim();
                const formatted = link.dataset.formatted;
                let status = statuses[formatted] ? (statusLabels[statuses[formatted]] || statuses[formatted]) : (clicked.has(formatted) ? 'Visited' : 'Not Visited');
                csv += `"${name}","${link.href}","${status}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ashby-tracker-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        });

        // Load saved state
        loadClicked();
        loadStatuses();
        updateStats();

        // Try to auto-load ashby-valid.csv first, fallback to ycCompanyNames.csv
        fetch('ashby-valid.csv')
            .then(r => r.ok ? r.text() : Promise.reject())
            .then(text => {
                companyNames = parseCSV(text);
                if (companyNames.length > 0) generateBtn.click();
                else throw new Error('empty');
            })
            .catch(() => {
                fetch('companynames.csv')
                    .then(r => r.text())
                    .then(text => {
                        companyNames = parseCSV(text);
                        if (companyNames.length > 0) generateBtn.click();
                        else grid.innerHTML = '<div class="empty">Upload ashby-valid.csv to get started</div>';
                    })
                    .catch(() => {
                        grid.innerHTML = '<div class="empty">Upload ashby-valid.csv to get started</div>';
                    });
            });
    </script>
</body>
</html>