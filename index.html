<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Validator</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .header {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            position: sticky;
            top: 0;
            background: #0a0a0a;
            padding: 15px 0;
            z-index: 500;
            border-bottom: 1px solid #222;
        }
        .header h1 { font-size: 20px; margin: 0; margin-right: 20px; }
        .filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
            width: 100%;
        }
        .filters button {
            padding: 6px 12px;
            font-size: 12px;
            background: #222;
            border: 1px solid #333;
        }
        .filters button:hover { background: #333; }
        .filters button.active { background: #4a9eff; border-color: #4a9eff; }
        input[type="file"] {
            padding: 10px;
            font-size: 13px;
            border: 2px dashed #333;
            border-radius: 6px;
            background: #111;
            color: #888;
            cursor: pointer;
        }
        input[type="file"]:hover { border-color: #555; }
        input[type="text"] {
            padding: 12px 16px;
            font-size: 14px;
            border: 2px solid #333;
            border-radius: 6px;
            background: #111;
            color: #fff;
            outline: none;
            width: 200px;
        }
        input[type="text"]:focus { border-color: #4a9eff; }
        input[type="text"]::placeholder { color: #555; }
        button {
            padding: 12px 24px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            background: #4a9eff;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }
        button:hover { background: #3a8eef; }
        button:disabled { background: #333; cursor: not-allowed; }
        .stats { font-size: 13px; color: #666; }
        .stats span { color: #4ade80; font-weight: 600; }
        .stats .valid-count { color: #4a9eff; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 8px;
        }
        .grid a {
            display: block;
            padding: 14px 12px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            color: #fff;
            text-decoration: none;
            font-size: 13px;
            text-align: center;
            transition: all 0.15s ease;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .grid a:hover { background: #252525; border-color: #4a9eff; }
        .grid a.clicked {
            background: #0d2a1a;
            border-color: #166534;
            color: #4ade80;
            opacity: 0.6;
        }
        .grid a.clicked::after { content: ' ‚úì'; }
        .grid a.applied-ashby { background: #1a1a2e; border-color: #4a9eff; color: #4a9eff; }
        .grid a.applied-ashby::after { content: ' ‚úì ASHBY'; font-size: 10px; font-weight: 700; }
        .grid a.applied-linkedin { background: #1a1a2e; border-color: #0a66c2; color: #5094d4; }
        .grid a.applied-linkedin::after { content: ' ‚úì LINKEDIN'; font-size: 10px; font-weight: 700; }
        .grid a.applied-yc { background: #2a1a0a; border-color: #f26625; color: #f59563; }
        .grid a.applied-yc::after { content: ' ‚úì YC'; font-size: 10px; font-weight: 700; }
        .grid a.applied-email { background: #1a2a1a; border-color: #22c55e; color: #4ade80; }
        .grid a.applied-email::after { content: ' ‚úì EMAIL'; font-size: 10px; font-weight: 700; }
        .grid a.applied-website { background: #2a1a2a; border-color: #a855f7; color: #c084fc; }
        .grid a.applied-website::after { content: ' ‚úì WEBSITE'; font-size: 10px; font-weight: 700; }
        .grid a.passed { background: #2a1a1a; border-color: #dc2626; color: #f87171; opacity: 0.5; }
        .grid a.passed::after { content: ' ‚úó PASSED'; font-size: 10px; font-weight: 700; }
        .grid a.not-qualified { background: #2a2a1a; border-color: #ca8a04; color: #facc15; opacity: 0.5; }
        .grid a.not-qualified::after { content: ' ‚úó NOT QUALIFIED'; font-size: 10px; font-weight: 700; }
        .grid a.no-jobs { background: #1a1a1a; border-color: #555; color: #666; opacity: 0.4; }
        .grid a.no-jobs::after { content: ' ‚Äî NO JOBS'; font-size: 10px; font-weight: 700; }
        .grid a.interviewing { background: #1a2e1a; border-color: #22c55e; color: #4ade80; }
        .grid a.interviewing::after { content: ' ‚òÖ INTERVIEWING'; font-size: 10px; font-weight: 700; }
        .grid a.failed-interview { background: #2a1a2a; border-color: #9333ea; color: #a855f7; opacity: 0.5; }
        .grid a.failed-interview::after { content: ' ‚úó FAILED INTERVIEW'; font-size: 10px; font-weight: 700; }
        .grid a.not-in-us { background: #1a1a1a; border-color: #065f46; color: #34d399; opacity: 0.4; }
        .grid a.not-in-us::after { content: ' üåç NOT IN US'; font-size: 10px; font-weight: 700; }
        .context-menu {
            position: fixed;
            background: #222;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 6px 0;
            z-index: 1000;
            min-width: 160px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .context-menu div { padding: 10px 16px; cursor: pointer; font-size: 13px; color: #fff; }
        .context-menu div:hover { background: #333; }
        .context-menu div.clear-status { border-top: 1px solid #444; margin-top: 6px; padding-top: 12px; color: #888; }
        .context-menu div.close-menu { color: #666; font-size: 12px; text-align: center; }
        .empty { color: #444; text-align: center; padding: 60px 20px; font-size: 14px; }
        .clear-btn { background: #333; margin-left: 10px; }
        .clear-btn:hover { background: #444; }
        .export-btn { background: #22c55e; }
        .export-btn:hover { background: #16a34a; }
        .import-btn { background: #f59e0b; }
        .import-btn:hover { background: #d97706; }
        .loading { color: #4a9eff; text-align: center; padding: 60px 20px; }
        .error { color: #f87171; text-align: center; padding: 60px 20px; }
        .sync-status { font-size: 11px; color: #666; }
        .sync-status.syncing { color: #4a9eff; }
        .sync-status.error { color: #f87171; }
        .sync-status.success { color: #4ade80; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Link Checker ‚úì</h1>
        <input type="file" id="csv-file" accept=".csv,.txt" title="Import companies from CSV">
        <button id="import-csv" class="import-btn">Import CSV to DB</button>
        <input type="text" id="search" placeholder="Search companies...">
        <button id="export" class="export-btn">Export CSV</button>
        <button id="clear" class="clear-btn">Clear All Statuses</button>
        <div class="stats">
            Visited: <span id="clicked-count">0</span> |
            Applied: <span id="applied-count">0</span> |
            Total: <span id="total-count" class="valid-count">0</span>
            <span id="sync-status" class="sync-status"></span>
        </div>
        <div class="filters">
            <button data-filter="all" class="active">All</button>
            <button data-filter="unvisited">Unvisited</button>
            <button data-filter="clicked">Visited</button>
            <button data-filter="applied">Applied (All)</button>
            <button data-filter="interviewing">Interviewing</button>
            <button data-filter="failed-interview">Failed Interview</button>
            <button data-filter="passed">Passed</button>
            <button data-filter="not-qualified">Not Qualified</button>
            <button data-filter="no-jobs">No Jobs</button>
            <button data-filter="not-in-us">Not in US</button>
        </div>
    </div>

    <div class="grid" id="grid">
        <div class="loading">Connecting to database...</div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // Replace these with your Supabase project credentials
        // ============================================
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';       // e.g., 'https://abcdefgh.supabase.co'
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';  // Your anon/public key

        // Initialize Supabase client
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const csvFile       = document.getElementById('csv-file');
        const importBtn     = document.getElementById('import-csv');
        const clearBtn      = document.getElementById('clear');
        const exportBtn     = document.getElementById('export');
        const searchInput   = document.getElementById('search');
        const grid          = document.getElementById('grid');
        const clickedCount  = document.getElementById('clicked-count');
        const appliedCount  = document.getElementById('applied-count');
        const totalCount    = document.getElementById('total-count');
        const syncStatus    = document.getElementById('sync-status');
        const filterBtns    = document.querySelectorAll('.filters button');

        // ============================================
        // STATE
        // ============================================
        let companyData         = [];   // Array of company objects from Supabase
        let currentFilter       = 'all';
        let clicked             = new Set();
        let statuses            = {};
        let currentContextLink  = null;

        const allStatuses = [
            'applied-ashby', 'applied-linkedin', 'applied-yc', 'applied-email', 'applied-website',
            'interviewing', 'failed-interview', 'passed', 'not-qualified', 'no-jobs', 'not-in-us'
        ];

        // ============================================
        // CONTEXT MENU
        // ============================================
        const contextMenu = document.createElement('div');
        contextMenu.className = 'context-menu';
        contextMenu.style.display = 'none';
        contextMenu.innerHTML = `
            <div data-status="applied-ashby">‚úì Applied - Ashby</div>
            <div data-status="applied-linkedin">‚úì Applied - LinkedIn</div>
            <div data-status="applied-yc">‚úì Applied - YC</div>
            <div data-status="applied-email">‚úì Applied - Email</div>
            <div data-status="applied-website">‚úì Applied - Website</div>
            <div data-status="interviewing">‚òÖ Interviewing</div>
            <div data-status="failed-interview">‚úó Failed Interview</div>
            <div data-status="passed">‚úó Passed</div>
            <div data-status="not-qualified">‚úó Not Qualified</div>
            <div data-status="no-jobs">‚Äî No Jobs</div>
            <div data-status="not-in-us">üåç Not in US</div>
            <div class="clear-status" data-status="clear">Clear Status</div>
            <div class="close-menu" data-status="close">‚úï Close</div>
        `;
        document.body.appendChild(contextMenu);

        document.addEventListener('click', () => contextMenu.style.display = 'none');
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') contextMenu.style.display = 'none'; });

        // ============================================
        // SUPABASE DATABASE FUNCTIONS
        // ============================================

        function setSyncStatus(message, type = '') {
            syncStatus.textContent = message;
            syncStatus.className = 'sync-status ' + type;
            if (type === 'success') {
                setTimeout(() => { syncStatus.textContent = ''; }, 2000);
            }
        }

        async function loadCompanies() {
            setSyncStatus('Loading...', 'syncing');
            const { data, error } = await db
                .from('companies')
                .select('*')
                .order('name');

            if (error) {
                console.error('Load error:', error);
                setSyncStatus('Load failed', 'error');
                return [];
            }
            setSyncStatus('Loaded', 'success');
            return data;
        }

        async function saveStatus(slug, status, visited = true) {
            setSyncStatus('Saving...', 'syncing');
            const { error } = await db
                .from('companies')
                .update({ status, visited })
                .eq('slug', slug);

            if (error) {
                console.error('Save error:', error);
                setSyncStatus('Save failed', 'error');
                return false;
            }
            setSyncStatus('Saved', 'success');
            return true;
        }

        async function markVisited(slug) {
            setSyncStatus('Saving...', 'syncing');
            const { error } = await db
                .from('companies')
                .update({ visited: true })
                .eq('slug', slug);

            if (error) {
                console.error('Visit error:', error);
                setSyncStatus('Save failed', 'error');
                return false;
            }
            setSyncStatus('Saved', 'success');
            return true;
        }

        async function clearAllStatuses() {
            setSyncStatus('Clearing...', 'syncing');
            const { error } = await db
                .from('companies')
                .update({ status: 'unvisited', visited: false });

            if (error) {
                console.error('Clear error:', error);
                setSyncStatus('Clear failed', 'error');
                return false;
            }
            setSyncStatus('Cleared', 'success');
            return true;
        }

        async function importCompaniesToDB(companies) {
            setSyncStatus('Importing...', 'syncing');

            // Upsert companies (insert or update if slug exists)
            const { error } = await db
                .from('companies')
                .upsert(
                    companies.map(c => ({
                        slug: c.slug,
                        name: c.name,
                        url: c.url,
                        status: 'unvisited',
                        visited: false
                    })),
                    { onConflict: 'slug', ignoreDuplicates: false }
                );

            if (error) {
                console.error('Import error:', error);
                setSyncStatus('Import failed', 'error');
                return false;
            }
            setSyncStatus(`Imported ${companies.length} companies`, 'success');
            return true;
        }

        // ============================================
        // MIGRATION FROM LOCALSTORAGE
        // ============================================

        async function migrateFromLocalStorage() {
            const migrated = localStorage.getItem('supabase-migrated');
            if (migrated) return;

            const oldClicked = JSON.parse(localStorage.getItem('ashby-clicked-v2') || '[]');
            const oldStatuses = JSON.parse(localStorage.getItem('ashby-statuses-v2') || '{}');

            if (oldClicked.length === 0 && Object.keys(oldStatuses).length === 0) {
                localStorage.setItem('supabase-migrated', 'true');
                return;
            }

            setSyncStatus('Migrating data...', 'syncing');

            let migrationErrors = 0;
            for (const slug of oldClicked) {
                const status = oldStatuses[slug] || 'unvisited';
                const { error } = await db
                    .from('companies')
                    .update({ visited: true, status: status !== 'unvisited' ? status : 'unvisited' })
                    .eq('slug', slug);
                if (error) migrationErrors++;
            }

            // Also migrate statuses for companies not in clicked set
            for (const [slug, status] of Object.entries(oldStatuses)) {
                if (!oldClicked.includes(slug)) {
                    const { error } = await db
                        .from('companies')
                        .update({ status, visited: true })
                        .eq('slug', slug);
                    if (error) migrationErrors++;
                }
            }

            if (migrationErrors === 0) {
                localStorage.setItem('supabase-migrated', 'true');
                setSyncStatus('Migration complete', 'success');
                console.log('Migration from localStorage complete');
            } else {
                setSyncStatus(`Migration had ${migrationErrors} errors`, 'error');
            }
        }

        // ============================================
        // CSV PARSING
        // ============================================

        function formatCompanyName(name) {
            return name.trim().toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '').replace(/-+/g, '');
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const companies = [];

            const startIndex = lines[0]?.toLowerCase().includes('company') ? 1 : 0;

            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;

                const match = line.match(/^"([^"]+)"/);
                let name;
                if (match) {
                    name = match[1];
                } else {
                    const cells = line.split(/[,\t]/);
                    name = cells[0]?.trim().replace(/^["']|["']$/g, '');
                }

                if (name && name.length > 1) {
                    const slug = formatCompanyName(name);
                    companies.push({
                        name: name,
                        slug: slug,
                        url: `https://jobs.ashbyhq.com/${slug}`
                    });
                }
            }

            // Remove duplicates by slug
            const seen = new Set();
            return companies.filter(c => {
                if (seen.has(c.slug)) return false;
                seen.add(c.slug);
                return true;
            });
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================

        function updateStats() {
            clickedCount.textContent = clicked.size;
            appliedCount.textContent = Object.values(statuses).filter(s => s.startsWith('applied')).length;
        }

        function applyFilters() {
            const query = searchInput.value.toLowerCase().trim();
            const links = grid.querySelectorAll('a');

            links.forEach(link => {
                const name = link.textContent.toLowerCase();
                const formatted = link.dataset.formatted;
                const status = statuses[formatted] || (clicked.has(formatted) ? 'clicked' : 'unvisited');

                let matchesFilter = currentFilter === 'all' ||
                    (currentFilter === 'applied' ? status.startsWith('applied') : status === currentFilter);
                let matchesSearch = query === '' || name.includes(query);

                link.style.display = (matchesFilter && matchesSearch) ? 'block' : 'none';
            });
        }

        function generateGrid() {
            if (companyData.length === 0) {
                grid.innerHTML = '<div class="empty">No companies in database. Import a CSV to get started.</div>';
                totalCount.textContent = '0';
                return;
            }

            grid.innerHTML = '';
            totalCount.textContent = companyData.length;

            companyData.forEach(company => {
                const link = document.createElement('a');
                link.href = company.url;
                link.target = '_blank';
                link.textContent = company.name;
                link.dataset.formatted = company.slug;

                if (company.visited) {
                    link.classList.add('clicked');
                    clicked.add(company.slug);
                }
                if (company.status && company.status !== 'unvisited') {
                    link.classList.remove('clicked');
                    link.classList.add(company.status);
                    statuses[company.slug] = company.status;
                }

                link.addEventListener('click', async function(e) {
                    e.preventDefault();
                    window.open(company.url, '_blank', 'noopener');
                    if (!statuses[company.slug]) {
                        this.classList.add('clicked');
                        clicked.add(company.slug);
                        updateStats();
                        await markVisited(company.slug);
                    }
                });

                link.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    currentContextLink = this;
                    contextMenu.style.display = 'block';
                    const x = Math.min(e.clientX, window.innerWidth - contextMenu.offsetWidth - 10);
                    const y = Math.min(e.clientY, window.innerHeight - contextMenu.offsetHeight - 10);
                    contextMenu.style.left = x + 'px';
                    contextMenu.style.top = y + 'px';
                });

                grid.appendChild(link);
            });

            updateStats();
            applyFilters();
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================

        filterBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                filterBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                applyFilters();
            });
        });

        contextMenu.addEventListener('click', async function(e) {
            const status = e.target.dataset.status;
            if (!status || !currentContextLink) return;
            if (status === 'close') { contextMenu.style.display = 'none'; return; }

            const formatted = currentContextLink.dataset.formatted;
            allStatuses.forEach(s => currentContextLink.classList.remove(s));
            currentContextLink.classList.remove('clicked');

            if (status === 'clear') {
                delete statuses[formatted];
                clicked.delete(formatted);
                await saveStatus(formatted, 'unvisited', false);
            } else {
                statuses[formatted] = status;
                currentContextLink.classList.add(status);
                clicked.add(formatted);
                await saveStatus(formatted, status, true);
            }

            updateStats();
            applyFilters();
            contextMenu.style.display = 'none';
        });

        searchInput.addEventListener('input', applyFilters);

        let pendingCSVData = null;
        csvFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                pendingCSVData = parseCSV(e.target.result);
                importBtn.textContent = `Import ${pendingCSVData.length} Companies`;
            };
            reader.readAsText(file);
        });

        importBtn.addEventListener('click', async function() {
            if (!pendingCSVData || pendingCSVData.length === 0) {
                alert('Please select a CSV file first');
                return;
            }

            this.disabled = true;
            this.textContent = 'Importing...';

            const success = await importCompaniesToDB(pendingCSVData);

            if (success) {
                // Reload data from database
                companyData = await loadCompanies();
                clicked.clear();
                statuses = {};
                generateGrid();
                pendingCSVData = null;
                csvFile.value = '';
            }

            this.disabled = false;
            this.textContent = 'Import CSV to DB';
        });

        clearBtn.addEventListener('click', async function() {
            if (confirm('Clear ALL statuses for ALL companies? This cannot be undone.')) {
                this.disabled = true;
                const success = await clearAllStatuses();
                if (success) {
                    clicked.clear();
                    statuses = {};
                    document.querySelectorAll('.grid a').forEach(a => {
                        allStatuses.forEach(s => a.classList.remove(s));
                        a.classList.remove('clicked');
                    });
                    updateStats();
                    applyFilters();
                }
                this.disabled = false;
            }
        });

        exportBtn.addEventListener('click', function() {
            const links = grid.querySelectorAll('a');
            if (links.length === 0) { alert('No companies to export'); return; }

            const statusLabels = {
                'applied-ashby': 'Applied - Ashby',
                'applied-linkedin': 'Applied - LinkedIn',
                'applied-yc': 'Applied - YC',
                'applied-email': 'Applied - Email',
                'applied-website': 'Applied - Website',
                'interviewing': 'Interviewing',
                'failed-interview': 'Failed Interview',
                'passed': 'Passed',
                'not-qualified': 'Not Qualified',
                'no-jobs': 'No Jobs',
                'not-in-us': 'Not in US'
            };

            let csv = 'Company,Ashby URL,Status\n';
            links.forEach(link => {
                const name = link.textContent.replace(/[‚úì‚úó‚òÖ‚Äî].*$/, '').trim();
                const formatted = link.dataset.formatted;
                let status = statuses[formatted] ? (statusLabels[statuses[formatted]] || statuses[formatted]) : (clicked.has(formatted) ? 'Visited' : 'Not Visited');
                csv += `"${name}","${link.href}","${status}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ashby-tracker-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        });

        // ============================================
        // INITIALIZATION
        // ============================================

        async function init() {
            // Check if Supabase is configured
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                grid.innerHTML = `
                    <div class="error">
                        <h3>Supabase Not Configured</h3>
                        <p>Edit this file and replace:</p>
                        <code>SUPABASE_URL</code> and <code>SUPABASE_ANON_KEY</code>
                        <p>with your Supabase project credentials.</p>
                        <p style="margin-top: 20px; color: #666;">
                            Get these from: Supabase Dashboard ‚Üí Settings ‚Üí API
                        </p>
                    </div>
                `;
                return;
            }

            try {
                // First, try to migrate any existing localStorage data
                await migrateFromLocalStorage();

                // Load companies from Supabase
                companyData = await loadCompanies();

                if (companyData.length === 0) {
                    grid.innerHTML = `
                        <div class="empty">
                            <h3>No companies in database</h3>
                            <p>Import your ashby-valid.csv file using the button above.</p>
                        </div>
                    `;
                    return;
                }

                generateGrid();

            } catch (error) {
                console.error('Init error:', error);
                grid.innerHTML = `
                    <div class="error">
                        <h3>Connection Error</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px; color: #666;">Check your Supabase credentials and try again.</p>
                    </div>
                `;
            }
        }

        // Start the app
        init();
    </script>
</body>
</html>
