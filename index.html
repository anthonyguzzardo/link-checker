<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Validator</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .header {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            position: sticky;
            top: 0;
            background: #0a0a0a;
            padding: 15px 0;
            z-index: 500;
            border-bottom: 1px solid #222;
        }
        .header h1 { font-size: 20px; margin: 0; margin-right: 20px; }
        .filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
            width: 100%;
        }
        .filters button {
            padding: 6px 12px;
            font-size: 12px;
            background: #222;
            border: 1px solid #333;
        }
        .filters button:hover { background: #333; }
        .filters button.active { background: #4a9eff; border-color: #4a9eff; }
        input[type="file"] {
            padding: 10px;
            font-size: 13px;
            border: 2px dashed #333;
            border-radius: 6px;
            background: #111;
            color: #888;
            cursor: pointer;
        }
        input[type="file"]:hover { border-color: #555; }
        input[type="text"] {
            padding: 12px 16px;
            font-size: 14px;
            border: 2px solid #333;
            border-radius: 6px;
            background: #111;
            color: #fff;
            outline: none;
            width: 200px;
        }
        input[type="text"]:focus { border-color: #4a9eff; }
        input[type="text"]::placeholder { color: #555; }
        button {
            padding: 12px 24px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            background: #4a9eff;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }
        button:hover { background: #3a8eef; }
        button:disabled { background: #333; cursor: not-allowed; }
        .stats { font-size: 13px; color: #666; }
        .stats span { color: #4ade80; font-weight: 600; }
        .stats .valid-count { color: #4a9eff; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 8px;
        }
        .grid a {
            display: block;
            padding: 14px 12px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            color: #fff;
            text-decoration: none;
            font-size: 13px;
            text-align: center;
            transition: all 0.15s ease;
            overflow: hidden;
        }
        .grid a .company-name {
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .grid a:hover { background: #252525; border-color: #4a9eff; }
        .grid a .applied-date {
            display: block;
            font-size: 10px;
            color: #666;
            margin-top: 4px;
            font-weight: 400;
        }
        .grid a .note-indicator {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 10px;
            height: 10px;
            background: #f59e0b;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 4px transparent;
        }
        .grid a .note-indicator:hover {
            background: #fbbf24;
            box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.2);
        }
        .grid a { position: relative; }
        .grid a.clicked {
            background: #0d2a1a;
            border-color: #166534;
            color: #4ade80;
            opacity: 0.6;
        }
        .grid a.clicked::after { content: ' ‚úì'; }
        .grid a.applied-ashby { background: #1a1a2e; border-color: #4a9eff; color: #4a9eff; }
        .grid a.applied-ashby::after { content: ' ‚úì ASHBY'; font-size: 10px; font-weight: 700; }
        .grid a.applied-linkedin { background: #1a1a2e; border-color: #0a66c2; color: #5094d4; }
        .grid a.applied-linkedin::after { content: ' ‚úì LINKEDIN'; font-size: 10px; font-weight: 700; }
        .grid a.applied-yc { background: #2a1a0a; border-color: #f26625; color: #f59563; }
        .grid a.applied-yc::after { content: ' ‚úì YC'; font-size: 10px; font-weight: 700; }
        .grid a.applied-email { background: #1a2a1a; border-color: #22c55e; color: #4ade80; }
        .grid a.applied-email::after { content: ' ‚úì EMAIL'; font-size: 10px; font-weight: 700; }
        .grid a.applied-website { background: #2a1a2a; border-color: #a855f7; color: #c084fc; }
        .grid a.applied-website::after { content: ' ‚úì WEBSITE'; font-size: 10px; font-weight: 700; }
        .grid a.skipped { background: #1a1a1a; border-color: #666; color: #888; opacity: 0.5; }
        .grid a.skipped::after { content: ' ‚Äî SKIPPED'; font-size: 10px; font-weight: 700; }
        .grid a.not-qualified { background: #2a2a1a; border-color: #ca8a04; color: #facc15; opacity: 0.5; }
        .grid a.not-qualified::after { content: ' ‚úó NOT QUALIFIED'; font-size: 10px; font-weight: 700; }
        .grid a.no-jobs { background: #1a1a1a; border-color: #555; color: #666; opacity: 0.4; }
        .grid a.no-jobs::after { content: ' ‚Äî NO JOBS'; font-size: 10px; font-weight: 700; }
        .grid a.interviewing { background: #1a2e1a; border-color: #22c55e; color: #4ade80; }
        .grid a.interviewing::after { content: ' ‚òÖ INTERVIEWING'; font-size: 10px; font-weight: 700; }
        .grid a.rejected { background: #2a1a1a; border-color: #ef4444; color: #f87171; opacity: 0.5; }
        .grid a.rejected::after { content: ' X REJECTED'; font-size: 10px; font-weight: 700; }
        .grid a.failed-interview { background: #2a1a2a; border-color: #9333ea; color: #a855f7; opacity: 0.5; }
        .grid a.failed-interview::after { content: ' X FAILED INTERVIEW'; font-size: 10px; font-weight: 700; }
        .grid a.not-in-us { background: #1a1a1a; border-color: #065f46; color: #34d399; opacity: 0.4; }
        .grid a.not-in-us::after { content: ' üåç NOT IN US'; font-size: 10px; font-weight: 700; }
        .context-menu {
            position: fixed;
            background: #222;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 6px 0;
            z-index: 1000;
            min-width: 160px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .context-menu div { padding: 10px 16px; cursor: pointer; font-size: 13px; color: #fff; }
        .context-menu div:hover { background: #333; }
        .context-menu div.clear-status { border-top: 1px solid #444; margin-top: 6px; padding-top: 12px; color: #888; }
        .context-menu div.close-menu { color: #666; font-size: 12px; text-align: center; }
        .empty { color: #444; text-align: center; padding: 60px 20px; font-size: 14px; }
        .export-btn { background: #22c55e; }
        .export-btn:hover { background: #16a34a; }
        .import-btn { background: #f59e0b; }
        .import-btn:hover { background: #d97706; }
        .loading { color: #4a9eff; text-align: center; padding: 60px 20px; }
        .error { color: #f87171; text-align: center; padding: 60px 20px; }
        .sync-status { font-size: 11px; color: #666; }
        .sync-status.syncing { color: #4a9eff; }
        .sync-status.error { color: #f87171; }
        .sync-status.success { color: #4ade80; }

        /* Auth styles */
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: #0a0a0a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .auth-box {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 40px;
            width: 100%;
            max-width: 360px;
        }
        .auth-box h2 {
            margin: 0 0 24px 0;
            font-size: 20px;
            text-align: center;
        }
        .auth-box input {
            width: 100%;
            padding: 12px 16px;
            font-size: 14px;
            border: 2px solid #333;
            border-radius: 6px;
            background: #111;
            color: #fff;
            outline: none;
            margin-bottom: 12px;
        }
        .auth-box input:focus { border-color: #4a9eff; }
        .auth-box button {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
        }
        .auth-error {
            color: #f87171;
            font-size: 13px;
            text-align: center;
            margin-top: 12px;
        }
        .logout-btn {
            background: #333;
            padding: 8px 16px;
            font-size: 12px;
        }
        .logout-btn:hover { background: #444; }
        .stats-btn { background: #8b5cf6; }
        .stats-btn:hover { background: #7c3aed; }

        /* Stats Modal */
        .stats-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }
        .stats-modal.open { display: flex; }
        .stats-modal-content {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .stats-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .stats-modal-header h2 { margin: 0; font-size: 20px; }
        .stats-modal-close {
            background: #333;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 4px;
        }
        .stats-modal-close:hover { background: #444; color: #fff; }
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 30px;
        }
        .stats-summary-item {
            background: #222;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }
        .stats-summary-item .number {
            font-size: 28px;
            font-weight: 700;
            color: #4a9eff;
        }
        .stats-summary-item .label {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }
        .chart-container { margin-top: 20px; }
        .chart-title {
            font-size: 14px;
            color: #888;
            margin-bottom: 16px;
        }
        .chart-bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 12px;
        }
        .chart-bar-label {
            width: 80px;
            font-size: 12px;
            color: #888;
            text-align: right;
        }
        .chart-bar-track {
            flex: 1;
            height: 24px;
            background: #222;
            border-radius: 4px;
            overflow: hidden;
        }
        .chart-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a9eff, #8b5cf6);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 11px;
            font-weight: 600;
            min-width: 30px;
        }

        /* LLM Prompt Button */
        .llm-prompt-btn {
            width: 100%;
            margin-top: 24px;
            background: linear-gradient(90deg, #8b5cf6, #ec4899);
            font-size: 15px;
            padding: 14px 24px;
        }
        .llm-prompt-btn:hover {
            background: linear-gradient(90deg, #7c3aed, #db2777);
        }

        /* Prompt Modal */
        .prompt-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .prompt-modal.open { display: flex; }
        .prompt-modal-content {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 24px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .prompt-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .prompt-modal-header h2 { margin: 0; font-size: 18px; }
        .prompt-modal-close {
            background: #333;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 4px;
        }
        .prompt-modal-close:hover { background: #444; color: #fff; }
        #prompt-text {
            flex: 1;
            min-height: 400px;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 13px;
            padding: 16px;
            resize: none;
            font-family: inherit;
            line-height: 1.6;
        }
        #prompt-text:focus {
            outline: none;
            border-color: #4a9eff;
        }
        .prompt-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            justify-content: flex-end;
        }
        .prompt-actions button {
            padding: 12px 24px;
            font-size: 14px;
        }
        #copy-prompt-btn {
            background: #22c55e;
        }
        #copy-prompt-btn:hover {
            background: #16a34a;
        }
        #copy-prompt-btn.copied {
            background: #4a9eff;
        }

        /* Notes Popup */
        .notes-popup {
            position: fixed;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 16px;
            z-index: 1001;
            width: 280px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            display: none;
        }
        .notes-popup textarea {
            width: 100%;
            height: 80px;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            color: #fff;
            font-size: 13px;
            padding: 10px 12px;
            resize: none;
            font-family: inherit;
            line-height: 1.4;
        }
        .notes-popup textarea:focus {
            outline: none;
            border-color: #4a9eff;
            background: #111;
        }
        .notes-popup textarea::placeholder { color: #555; }
        .notes-popup-btns {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            justify-content: flex-end;
        }
        .notes-popup-btns button {
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 6px;
        }
        .notes-popup-btns .cancel-btn {
            background: #2a2a2a;
            color: #888;
        }
        .notes-popup-btns .cancel-btn:hover {
            background: #333;
            color: #fff;
        }
    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div class="auth-overlay" id="auth-overlay">
        <div class="auth-box">
            <h2>Login Required</h2>
            <input type="email" id="auth-email" placeholder="Email">
            <input type="password" id="auth-password" placeholder="Password">
            <button id="auth-submit">Login</button>
            <div class="auth-error" id="auth-error"></div>
        </div>
    </div>

    <div class="header" id="main-header" style="display: none;">
        <h1>Link Checker ‚úì</h1>
        <input type="file" id="csv-file" accept=".csv,.txt" title="Import companies from CSV">
        <button id="import-csv" class="import-btn">Import CSV to DB</button>
        <input type="text" id="search" placeholder="Search companies...">
        <button id="stats-btn" class="stats-btn">Stats</button>
        <button id="export" class="export-btn">Export CSV</button>
        <button id="logout" class="logout-btn">Logout</button>
        <div class="stats">
            Visited: <span id="clicked-count">0</span> |
            Applied: <span id="applied-count">0</span> |
            Total: <span id="total-count" class="valid-count">0</span>
            <span id="sync-status" class="sync-status"></span>
        </div>
        <div class="filters">
            <button data-filter="all" class="active">All</button>
            <button data-filter="unvisited">Unvisited</button>
            <button data-filter="clicked">Visited</button>
            <button data-filter="applied">Applied (All)</button>
            <button data-filter="interviewing">Interviewing</button>
            <button data-filter="rejected">Rejected</button>
            <button data-filter="failed-interview">Failed Interview</button>
            <button data-filter="skipped">Skipped</button>
            <button data-filter="not-qualified">Not Qualified</button>
            <button data-filter="no-jobs">No Jobs</button>
            <button data-filter="not-in-us">Not in US</button>
        </div>
    </div>

    <div class="grid" id="grid" style="display: none;">
        <div class="loading">Connecting to database...</div>
    </div>

    <!-- Stats Modal -->
    <div class="stats-modal" id="stats-modal">
        <div class="stats-modal-content">
            <div class="stats-modal-header">
                <h2>Application Stats</h2>
                <button class="stats-modal-close" id="stats-modal-close">‚úï</button>
            </div>
            <div class="stats-summary" id="stats-summary"></div>
            <div class="chart-container">
                <div class="chart-title">Applications by Day</div>
                <div id="stats-chart"></div>
            </div>
            <button class="llm-prompt-btn" id="llm-prompt-btn">Generate LLM Analysis Prompt</button>
        </div>
    </div>

    <!-- LLM Prompt Modal -->
    <div class="prompt-modal" id="prompt-modal">
        <div class="prompt-modal-content">
            <div class="prompt-modal-header">
                <h2>LLM Analysis Prompt</h2>
                <button class="prompt-modal-close" id="prompt-modal-close">‚úï</button>
            </div>
            <textarea id="prompt-text" readonly></textarea>
            <div class="prompt-actions">
                <button id="copy-prompt-btn">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- Notes Popup -->
    <div class="notes-popup" id="notes-popup">
        <textarea id="notes-textarea" placeholder="Add a note..."></textarea>
        <div class="notes-popup-btns">
            <button class="cancel-btn" id="notes-cancel">Cancel</button>
            <button id="notes-save">Save</button>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // Replace these with your Supabase project credentials
        // ============================================
        const SUPABASE_URL = 'https://ampsliudevabkybsbqil.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtcHNsaXVkZXZhYmt5YnNicWlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMjE4MTIsImV4cCI6MjA4MTg5NzgxMn0.iZFMR_NheMnFajb_TiW-Gy2dXHgsLpmIgpgJV20RCiM';

        // Initialize Supabase client
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // AUTHENTICATION
        // ============================================
        const authOverlay = document.getElementById('auth-overlay');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authSubmit = document.getElementById('auth-submit');
        const authError = document.getElementById('auth-error');
        const mainHeader = document.getElementById('main-header');
        const logoutBtn = document.getElementById('logout');

        let appInitialized = false;
        function showApp() {
            authOverlay.style.display = 'none';
            mainHeader.style.display = 'flex';
            document.getElementById('grid').style.display = 'grid';
            if (!appInitialized) {
                appInitialized = true;
                init(); // Initialize the app after login
            }
        }

        function showLogin() {
            authOverlay.style.display = 'flex';
            mainHeader.style.display = 'none';
            document.getElementById('grid').style.display = 'none';
        }

        // Check for existing session on load
        db.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                showApp();
            } else {
                showLogin();
            }
        });

        // Listen for auth changes
        db.auth.onAuthStateChange((event, session) => {
            if (session) {
                showApp();
            } else {
                showLogin();
            }
        });

        // Login handler
        authSubmit.addEventListener('click', async () => {
            authError.textContent = '';
            const email = authEmail.value.trim();
            const password = authPassword.value;

            if (!email || !password) {
                authError.textContent = 'Please enter email and password';
                return;
            }

            const { error } = await db.auth.signInWithPassword({ email, password });
            if (error) {
                authError.textContent = error.message;
            }
        });

        // Enter key to submit
        authPassword.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') authSubmit.click();
        });

        // Logout handler
        logoutBtn.addEventListener('click', async () => {
            await db.auth.signOut();
        });

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const csvFile       = document.getElementById('csv-file');
        const importBtn     = document.getElementById('import-csv');
        const exportBtn     = document.getElementById('export');
        const searchInput   = document.getElementById('search');
        const grid          = document.getElementById('grid');
        const clickedCount  = document.getElementById('clicked-count');
        const appliedCount  = document.getElementById('applied-count');
        const totalCount    = document.getElementById('total-count');
        const syncStatus    = document.getElementById('sync-status');
        const filterBtns    = document.querySelectorAll('.filters button');
        const statsBtn      = document.getElementById('stats-btn');
        const statsModal    = document.getElementById('stats-modal');
        const statsModalClose = document.getElementById('stats-modal-close');
        const statsSummary  = document.getElementById('stats-summary');
        const statsChart    = document.getElementById('stats-chart');
        const notesPopup    = document.getElementById('notes-popup');
        const notesTextarea = document.getElementById('notes-textarea');
        const notesSave     = document.getElementById('notes-save');
        const notesCancel   = document.getElementById('notes-cancel');
        const llmPromptBtn  = document.getElementById('llm-prompt-btn');
        const promptModal   = document.getElementById('prompt-modal');
        const promptModalClose = document.getElementById('prompt-modal-close');
        const promptText    = document.getElementById('prompt-text');
        const copyPromptBtn = document.getElementById('copy-prompt-btn');

        // ============================================
        // STATE
        // ============================================
        let companyData         = [];   // Array of company objects from Supabase
        let currentFilter       = 'all';
        let clicked             = new Set();
        let statuses            = {};
        let notes               = {};
        let currentContextLink  = null;
        let currentNoteSlug     = null;

        const allStatuses = [
            'applied-ashby', 'applied-linkedin', 'applied-yc', 'applied-email', 'applied-website',
            'interviewing', 'rejected', 'failed-interview', 'skipped', 'not-qualified', 'no-jobs', 'not-in-us'
        ];

        // ============================================
        // CONTEXT MENU
        // ============================================
        const contextMenu = document.createElement('div');
        contextMenu.className = 'context-menu';
        contextMenu.style.display = 'none';
        contextMenu.innerHTML = `
            <div data-status="applied-ashby"    >‚úì Applied - Ashby</div>
            <div data-status="applied-linkedin" >‚úì Applied - LinkedIn</div>
            <div data-status="applied-yc"       >‚úì Applied - YC</div>
            <div data-status="applied-email"    >‚úì Applied - Email</div>
            <div data-status="applied-website"  >‚úì Applied - Website</div>
            <div data-status="interviewing"     >Interviewing</div>
            <div data-status="rejected"         >X Rejected</div>
            <div data-status="failed-interview" >X Failed Interview</div>
            <div data-status="skipped"          >‚Äî Skipped</div>
            <div data-status="not-qualified"    >‚úó Not Qualified</div>
            <div data-status="no-jobs"          >‚Äî No Jobs</div>
            <div data-status="not-in-us"        >üåç Not in US</div>
            <div class="clear-status" data-status="clear">Clear Status</div>
            <div data-action="note" style="border-top: 1px solid #444; margin-top: 6px; padding-top: 12px;">Add Note</div>
            <div class="close-menu" data-status="close">‚úï Close</div>
        `;
        document.body.appendChild(contextMenu);

        document.addEventListener('click', () => contextMenu.style.display = 'none');
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') contextMenu.style.display = 'none'; });

        // ============================================
        // SUPABASE DATABASE FUNCTIONS
        // ============================================

        function setSyncStatus(message, type = '') {
            syncStatus.textContent = message;
            syncStatus.className = 'sync-status ' + type;
            if (type === 'success') {
                setTimeout(() => { syncStatus.textContent = ''; }, 2000);
            }
        }

        async function loadCompanies() {
            setSyncStatus('Loading...', 'syncing');
            const { data, error } = await db
                .from('companies')
                .select('*')
                .eq('link_status', 'active')  // Only show validated active links
                .order('name');

            if (error) {
                console.error('Load error:', error);
                setSyncStatus('Load failed', 'error');
                return [];
            }
            setSyncStatus('Loaded', 'success');
            return data;
        }

        async function saveStatus(slug, status, visited = true) {
            setSyncStatus('Saving...', 'syncing');
            const updates = { status, visited };
            if (status.startsWith('applied-')) {
                updates.applied_at = new Date().toISOString();
            }
            const { error } = await db
                .from('companies')
                .update(updates)
                .eq('slug', slug);

            if (error) {
                console.error('Save error:', error);
                setSyncStatus('Save failed', 'error');
                return false;
            }
            setSyncStatus('Saved', 'success');
            return true;
        }

        async function markVisited(slug) {
            setSyncStatus('Saving...', 'syncing');
            const { error } = await db
                .from('companies')
                .update({ visited: true })
                .eq('slug', slug);

            if (error) {
                console.error('Visit error:', error);
                setSyncStatus('Save failed', 'error');
                return false;
            }
            setSyncStatus('Saved', 'success');
            return true;
        }

        async function clearAllStatuses() {
            setSyncStatus('Clearing...', 'syncing');
            const { error } = await db
                .from('companies')
                .update({ status: 'unvisited', visited: false });

            if (error) {
                console.error('Clear error:', error);
                setSyncStatus('Clear failed', 'error');
                return false;
            }
            setSyncStatus('Cleared', 'success');
            return true;
        }

        async function saveNote(slug, note) {
            setSyncStatus('Saving...', 'syncing');
            const { error } = await db
                .from('companies')
                .update({ notes: note })
                .eq('slug', slug);

            if (error) {
                console.error('Note error:', error);
                setSyncStatus('Save failed', 'error');
                return false;
            }
            setSyncStatus('Saved', 'success');
            return true;
        }

        async function importCompaniesToDB(companies) {
            setSyncStatus('Importing...', 'syncing');

            // Upsert companies (insert or update if slug exists)
            const { error } = await db
                .from('companies')
                .upsert(
                    companies.map(c => ({
                        slug: c.slug,
                        name: c.name,
                        url: c.url,
                        status: 'unvisited',
                        visited: false,
                        link_status: 'unchecked'  // Needs validation before showing
                    })),
                    { onConflict: 'slug', ignoreDuplicates: false }
                );

            if (error) {
                console.error('Import error:', error);
                setSyncStatus('Import failed', 'error');
                return false;
            }
            setSyncStatus(`Imported ${companies.length} companies`, 'success');
            return true;
        }

        async function checkUrl(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) return 'dead';
                const text = await response.text();
                // Only reject if Ashby explicitly says no org/jobBoard
                const noPage = text.includes('"organization":null') || text.includes('"jobBoard":null');
                return noPage ? 'dead' : 'active';
            } catch {
                return 'dead';
            }
        }

        async function validateUnchecked(onProgress) {
            const { data: companies, error } = await db
                .from('companies')
                .select('id, name, slug, url')
                .eq('link_status', 'unchecked')
                .order('name');

            if (error || !companies || companies.length === 0) {
                return { active: 0, dead: 0 };
            }

            let activeCount = 0;
            let deadCount = 0;

            // Process in batches of 5
            for (let i = 0; i < companies.length; i += 5) {
                const batch = companies.slice(i, i + 5);

                const results = await Promise.all(
                    batch.map(async (company) => {
                        const linkStatus = await checkUrl(company.url);
                        return { ...company, linkStatus };
                    })
                );

                for (const result of results) {
                    await db
                        .from('companies')
                        .update({ link_status: result.linkStatus })
                        .eq('id', result.id);

                    if (result.linkStatus === 'active') activeCount++;
                    else deadCount++;
                }

                if (onProgress) {
                    onProgress(Math.min(i + 5, companies.length), companies.length, activeCount, deadCount);
                }

                // Small delay for rate limiting
                await new Promise(r => setTimeout(r, 100));
            }

            return { active: activeCount, dead: deadCount };
        }

        // ============================================
        // MIGRATION FROM LOCALSTORAGE
        // ============================================

        async function migrateFromLocalStorage() {
            const migrated = localStorage.getItem('supabase-migrated');
            if (migrated) return;

            const oldClicked = JSON.parse(localStorage.getItem('ashby-clicked-v2') || '[]');
            const oldStatuses = JSON.parse(localStorage.getItem('ashby-statuses-v2') || '{}');

            if (oldClicked.length === 0 && Object.keys(oldStatuses).length === 0) {
                localStorage.setItem('supabase-migrated', 'true');
                return;
            }

            setSyncStatus('Migrating data...', 'syncing');

            let migrationErrors = 0;
            for (const slug of oldClicked) {
                const status = oldStatuses[slug] || 'unvisited';
                const { error } = await db
                    .from('companies')
                    .update({ visited: true, status: status !== 'unvisited' ? status : 'unvisited' })
                    .eq('slug', slug);
                if (error) migrationErrors++;
            }

            // Also migrate statuses for companies not in clicked set
            for (const [slug, status] of Object.entries(oldStatuses)) {
                if (!oldClicked.includes(slug)) {
                    const { error } = await db
                        .from('companies')
                        .update({ status, visited: true })
                        .eq('slug', slug);
                    if (error) migrationErrors++;
                }
            }

            if (migrationErrors === 0) {
                localStorage.setItem('supabase-migrated', 'true');
                setSyncStatus('Migration complete', 'success');
                console.log('Migration from localStorage complete');
            } else {
                setSyncStatus(`Migration had ${migrationErrors} errors`, 'error');
            }
        }

        // ============================================
        // CSV PARSING
        // ============================================

        function formatCompanyName(name) {
            return name.trim().toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '').replace(/-+/g, '');
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const companies = [];

            const startIndex = lines[0]?.toLowerCase().includes('company') ? 1 : 0;

            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;

                const match = line.match(/^"([^"]+)"/);
                let name;
                if (match) {
                    name = match[1];
                } else {
                    const cells = line.split(/[,\t]/);
                    name = cells[0]?.trim().replace(/^["']|["']$/g, '');
                }

                if (name && name.length > 1) {
                    const slug = formatCompanyName(name);
                    companies.push({
                        name: name,
                        slug: slug,
                        url: `https://jobs.ashbyhq.com/${slug}`
                    });
                }
            }

            // Remove duplicates by slug
            const seen = new Set();
            return companies.filter(c => {
                if (seen.has(c.slug)) return false;
                seen.add(c.slug);
                return true;
            });
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================

        function updateStats() {
            clickedCount.textContent = clicked.size;
            appliedCount.textContent = Object.values(statuses).filter(s => s.startsWith('applied')).length;
        }

        function applyFilters() {
            const query = searchInput.value.toLowerCase().trim();
            const links = grid.querySelectorAll('a');

            links.forEach(link => {
                const name = link.textContent.toLowerCase();
                const formatted = link.dataset.formatted;
                const status = statuses[formatted] || (clicked.has(formatted) ? 'clicked' : 'unvisited');

                let matchesFilter = currentFilter === 'all' ||
                    (currentFilter === 'applied' ? status.startsWith('applied') : status === currentFilter);
                let matchesSearch = query === '' || name.includes(query);

                link.style.display = (matchesFilter && matchesSearch) ? 'block' : 'none';
            });
        }

        function generateGrid() {
            if (companyData.length === 0) {
                grid.innerHTML = '<div class="empty">No companies in database. Import a CSV to get started.</div>';
                totalCount.textContent = '0';
                return;
            }

            grid.innerHTML = '';
            totalCount.textContent = companyData.length;

            companyData.forEach(company => {
                const link = document.createElement('a');
                link.href = company.url;
                link.target = '_blank';
                link.dataset.formatted = company.slug;

                const nameSpan = document.createElement('span');
                nameSpan.className = 'company-name';
                nameSpan.textContent = company.name;
                link.appendChild(nameSpan);

                if (company.applied_at) {
                    const dateSpan = document.createElement('span');
                    dateSpan.className = 'applied-date';
                    dateSpan.textContent = new Date(company.applied_at).toLocaleDateString();
                    link.appendChild(dateSpan);
                }

                if (company.notes) {
                    const noteIndicator = document.createElement('span');
                    noteIndicator.className = 'note-indicator';
                    link.appendChild(noteIndicator);
                    link.title = company.notes;
                    notes[company.slug] = company.notes;
                }

                if (company.visited) {
                    link.classList.add('clicked');
                    clicked.add(company.slug);
                }
                if (company.status && company.status !== 'unvisited') {
                    link.classList.remove('clicked');
                    link.classList.add(company.status);
                    statuses[company.slug] = company.status;
                }

                link.addEventListener('click', async function(e) {
                    e.preventDefault();
                    window.open(company.url, '_blank', 'noopener');
                    if (!statuses[company.slug]) {
                        this.classList.add('clicked');
                        clicked.add(company.slug);
                        updateStats();
                        await markVisited(company.slug);
                    }
                });

                link.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    currentContextLink = this;
                    contextMenu.style.display = 'block';
                    const x = Math.min(e.clientX, window.innerWidth - contextMenu.offsetWidth - 10);
                    const y = Math.min(e.clientY, window.innerHeight - contextMenu.offsetHeight - 10);
                    contextMenu.style.left = x + 'px';
                    contextMenu.style.top = y + 'px';
                });

                grid.appendChild(link);
            });

            updateStats();
            applyFilters();
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================

        filterBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                filterBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                applyFilters();
            });
        });

        contextMenu.addEventListener('click', async function(e) {
            const action = e.target.dataset.action;
            if (action === 'note' && currentContextLink) {
                e.stopPropagation();
                const slug = currentContextLink.dataset.formatted;
                currentNoteSlug = slug;
                notesTextarea.value = notes[slug] || '';
                notesPopup.style.display = 'block';
                const rect = currentContextLink.getBoundingClientRect();
                notesPopup.style.left = Math.min(rect.left, window.innerWidth - 300) + 'px';
                notesPopup.style.top = Math.min(rect.bottom + 5, window.innerHeight - 150) + 'px';
                notesTextarea.focus();
                contextMenu.style.display = 'none';
                return;
            }

            const status = e.target.dataset.status;
            if (!status || !currentContextLink) return;
            if (status === 'close') { contextMenu.style.display = 'none'; return; }

            const formatted = currentContextLink.dataset.formatted;
            allStatuses.forEach(s => currentContextLink.classList.remove(s));
            currentContextLink.classList.remove('clicked');

            if (status === 'clear') {
                delete statuses[formatted];
                clicked.delete(formatted);
                // Remove any existing date span
                const existingDate = currentContextLink.querySelector('.applied-date');
                if (existingDate) existingDate.remove();
                await saveStatus(formatted, 'unvisited', false);
            } else {
                statuses[formatted] = status;
                currentContextLink.classList.add(status);
                clicked.add(formatted);
                // Add or update date span for applied statuses
                if (status.startsWith('applied-')) {
                    let dateSpan = currentContextLink.querySelector('.applied-date');
                    if (!dateSpan) {
                        dateSpan = document.createElement('span');
                        dateSpan.className = 'applied-date';
                        currentContextLink.appendChild(dateSpan);
                    }
                    dateSpan.textContent = new Date().toLocaleDateString();
                }
                await saveStatus(formatted, status, true);
            }

            updateStats();
            applyFilters();
            contextMenu.style.display = 'none';
        });

        searchInput.addEventListener('input', applyFilters);

        let pendingCSVData = null;
        csvFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                pendingCSVData = parseCSV(e.target.result);
                importBtn.textContent = `Import ${pendingCSVData.length} Companies`;
            };
            reader.readAsText(file);
        });

        importBtn.addEventListener('click', async function() {
            if (!pendingCSVData || pendingCSVData.length === 0) {
                alert('Please select a CSV file first');
                return;
            }

            this.disabled = true;
            this.textContent = 'Importing...';

            const success = await importCompaniesToDB(pendingCSVData);

            if (success) {
                // Validate the newly imported companies
                this.textContent = 'Validating URLs...';
                setSyncStatus('Validating...', 'syncing');

                const { active, dead } = await validateUnchecked((current, total, activeCount, deadCount) => {
                    this.textContent = `Validating ${current}/${total}...`;
                    setSyncStatus(`‚úì ${activeCount} active, ‚úó ${deadCount} dead`, 'syncing');
                });

                setSyncStatus(`Done! ${active} active, ${dead} dead`, 'success');

                // Reload data from database
                companyData = await loadCompanies();
                clicked.clear();
                statuses = {};
                generateGrid();
                pendingCSVData = null;
                csvFile.value = '';
            }

            this.disabled = false;
            this.textContent = 'Import CSV to DB';
        });

        exportBtn.addEventListener('click', function() {
            const links = grid.querySelectorAll('a');
            if (links.length === 0) { alert('No companies to export'); return; }

            const statusLabels = {
                'applied-ashby': 'Applied - Ashby',
                'applied-linkedin': 'Applied - LinkedIn',
                'applied-yc': 'Applied - YC',
                'applied-email': 'Applied - Email',
                'applied-website': 'Applied - Website',
                'interviewing': 'Interviewing',
                'rejected': 'Rejected',
                'failed-interview': 'Failed Interview',
                'skipped': 'Skipped',
                'not-qualified': 'Not Qualified',
                'no-jobs': 'No Jobs',
                'not-in-us': 'Not in US'
            };

            let csv = 'Company,Ashby URL,Status\n';
            links.forEach(link => {
                const name = link.textContent.replace(/[‚úì‚úó‚òÖ‚Äî].*$/, '').trim();
                const formatted = link.dataset.formatted;
                let status = statuses[formatted] ? (statusLabels[statuses[formatted]] || statuses[formatted]) : (clicked.has(formatted) ? 'Visited' : 'Not Visited');
                csv += `"${name}","${link.href}","${status}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ashby-tracker-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        });

        // ============================================
        // STATS MODAL
        // ============================================

        function renderStats() {
            // Calculate summary stats
            const applied = companyData.filter(c => c.status?.startsWith('applied-'));
            const interviewing = companyData.filter(c => c.status === 'interviewing');
            const rejected = companyData.filter(c => c.status === 'rejected' || c.status === 'failed-interview');

            const responseCount = interviewing.length + rejected.length;
            const responseRate = applied.length > 0 ? Math.round((responseCount / applied.length) * 100) : 0;

            statsSummary.innerHTML = `
                <div class="stats-summary-item">
                    <div class="number">${applied.length}</div>
                    <div class="label">Applied</div>
                </div>
                <div class="stats-summary-item">
                    <div class="number">${interviewing.length}</div>
                    <div class="label">Interviewing</div>
                </div>
                <div class="stats-summary-item">
                    <div class="number">${rejected.length}</div>
                    <div class="label">Rejected</div>
                </div>
                <div class="stats-summary-item">
                    <div class="number">${responseRate}%</div>
                    <div class="label">Response Rate</div>
                </div>
            `;

            // Group applications by day
            const byDay = {};
            applied.forEach(c => {
                if (c.applied_at) {
                    const day = new Date(c.applied_at).toLocaleDateString();
                    byDay[day] = (byDay[day] || 0) + 1;
                }
            });

            // Sort by date and get last 14 days max
            const sortedDays = Object.entries(byDay)
                .sort((a, b) => new Date(a[0]) - new Date(b[0]))
                .slice(-14);

            if (sortedDays.length === 0) {
                statsChart.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No application dates recorded yet</div>';
                return;
            }

            const maxCount = Math.max(...sortedDays.map(d => d[1]));

            statsChart.innerHTML = sortedDays.map(([day, count]) => {
                const pct = (count / maxCount) * 100;
                const shortDay = new Date(day).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                return `
                    <div class="chart-bar-row">
                        <div class="chart-bar-label">${shortDay}</div>
                        <div class="chart-bar-track">
                            <div class="chart-bar-fill" style="width: ${pct}%">${count}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        statsBtn.addEventListener('click', () => {
            renderStats();
            statsModal.classList.add('open');
        });

        statsModalClose.addEventListener('click', () => {
            statsModal.classList.remove('open');
        });

        statsModal.addEventListener('click', (e) => {
            if (e.target === statsModal) statsModal.classList.remove('open');
        });

        // ============================================
        // LLM PROMPT GENERATOR
        // ============================================

        function generateLLMPrompt() {
            const now = Date.now();
            const ghostedThreshold = 14 * 24 * 60 * 60 * 1000; // 14 days

            // Calculate all stats
            const applied = companyData.filter(c => c.status?.startsWith('applied-'));
            const interviewing = companyData.filter(c => c.status === 'interviewing');
            const rejected = companyData.filter(c => c.status === 'rejected');
            const failedInterview = companyData.filter(c => c.status === 'failed-interview');
            const skipped = companyData.filter(c => c.status === 'skipped');

            // Breakdown by application method
            const byMethod = {
                ashby: applied.filter(c => c.status === 'applied-ashby').length,
                linkedin: applied.filter(c => c.status === 'applied-linkedin').length,
                yc: applied.filter(c => c.status === 'applied-yc').length,
                email: applied.filter(c => c.status === 'applied-email').length,
                website: applied.filter(c => c.status === 'applied-website').length,
            };

            // Calculate ghosted (applied > 14 days ago, still in applied-* status)
            const ghosted = applied.filter(c => {
                if (!c.applied_at) return false;
                const appliedTime = new Date(c.applied_at).getTime();
                const daysSince = now - appliedTime;
                return daysSince > ghostedThreshold;
            });

            // Response stats (skipped doesn't count - that's you passing on them)
            const responseCount = interviewing.length + rejected.length + failedInterview.length;
            const responseRate = applied.length > 0 ? Math.round((responseCount / applied.length) * 100) : 0;

            // Date range
            const appliedDates = applied
                .filter(c => c.applied_at)
                .map(c => new Date(c.applied_at))
                .sort((a, b) => a - b);

            const startDate = appliedDates[0];
            const endDate = appliedDates[appliedDates.length - 1];
            const weeksSince = startDate ? Math.ceil((now - startDate.getTime()) / (7 * 24 * 60 * 60 * 1000)) : 0;
            const appsPerWeek = weeksSince > 0 ? Math.round(applied.length / weeksSince) : applied.length;

            // Collect notes/feedback
            const companiesWithNotes = companyData.filter(c => c.notes && c.notes.trim());

            // Format date helper
            const formatDate = (date) => date ? date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : 'N/A';

            // Build the prompt
            let prompt = `I'm Anthony Guzzardo, a full-stack software engineer and founder of Mr. Fox, LLC based in Chicago. I graduated from DePaul University with a CS degree in 2023. I've shipped a live iOS app called Rangley (40 active users on the App Store) and I'm currently building a $36,000 marketplace platform (MyDailyDeals) for a client. My stack includes Swift, TypeScript, Python, C#, PostgreSQL, and Vapor. I have professional experience at EL3 Tech LLC (financial pipelines, crypto analysis) and Treevah LLC (CI/CD, security). I'm actively job searching and willing to relocate to San Francisco or internationally.

**My Job Search Stats (as of ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}):**

- Job search started: ${formatDate(startDate)}${weeksSince > 0 ? ` (${weeksSince} week${weeksSince !== 1 ? 's' : ''} ago)` : ''}
- Total applications: ${applied.length}
- Responses received: ${responseCount} (${responseRate}% response rate)
- Ghosted (no response after 14 days): ${ghosted.length}
- Rejected at initial screen: ${rejected.length}
- Made it to interview stage: ${interviewing.length + failedInterview.length}
- Rejected after interview: ${failedInterview.length}
- Currently interviewing: ${interviewing.length}
- Skipped by me (not interested): ${skipped.length}

**Application Velocity:**

- Applications per week: ${appsPerWeek}
- Most recent application: ${formatDate(endDate)}

**Application Method Breakdown:**

- Applied via Ashby: ${byMethod.ashby}
- Applied via LinkedIn: ${byMethod.linkedin}
- Applied via YC: ${byMethod.yc}
- Applied via Email: ${byMethod.email}
- Applied via Company Website: ${byMethod.website}
`;

            // Add notes/feedback section if there are any
            if (companiesWithNotes.length > 0) {
                prompt += `\n**Feedback/Notes Received:**\n\n`;
                companiesWithNotes.forEach(c => {
                    const statusLabel = c.status ? c.status.replace(/-/g, ' ').replace(/applied /i, 'Applied - ') : 'Unknown';
                    prompt += `- ${c.name} (${statusLabel}): "${c.notes}"\n`;
                });
            }

            // Add the instructions for the LLM
            prompt += `
**Based on this data, I need you to:**

A. **Motivation:** Give me genuine encouragement to keep going. Not generic bullshit ‚Äî specific to my situation. Acknowledge that this is hard and that my stats aren't a reflection of my ability to ship real products.

B. **Pivot Analysis:** Should I be targeting different types of companies? Different role types? Different geographies? Am I wasting time on certain application methods? Be specific.

C. **Improvement Areas:** What should I actively work on? Is it my resume? My interview skills? My portfolio? The way I'm applying? The volume of applications? Tell me what to fix.

D. **Pattern Recognition:** Look at my stats and tell me anything interesting. Maybe I do better with certain application methods. Maybe my response rate is actually decent but I'm dying at interviews. Find the signal in the noise.

E. **General Advice:** Anything else. Networking strategies, ways to stand out, whether I should cold-email founders, whether my client work and shipped app are being positioned correctly ‚Äî whatever you think would help.

Be honest. Be specific. Reference my actual numbers. Don't sugarcoat it but don't be a dick either.`;

            return prompt;
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (err) {
                console.error('Copy failed:', err);
                return false;
            }
        }

        llmPromptBtn.addEventListener('click', () => {
            const prompt = generateLLMPrompt();
            promptText.value = prompt;
            statsModal.classList.remove('open');
            promptModal.classList.add('open');
        });

        promptModalClose.addEventListener('click', () => {
            promptModal.classList.remove('open');
        });

        promptModal.addEventListener('click', (e) => {
            if (e.target === promptModal) promptModal.classList.remove('open');
        });

        copyPromptBtn.addEventListener('click', async () => {
            const success = await copyToClipboard(promptText.value);
            if (success) {
                copyPromptBtn.textContent = 'Copied!';
                copyPromptBtn.classList.add('copied');
                setTimeout(() => {
                    copyPromptBtn.textContent = 'Copy to Clipboard';
                    copyPromptBtn.classList.remove('copied');
                }, 2000);
            }
        });

        // ============================================
        // NOTES POPUP
        // ============================================

        notesCancel.addEventListener('click', () => {
            notesPopup.style.display = 'none';
            currentNoteSlug = null;
        });

        notesSave.addEventListener('click', async () => {
            if (!currentNoteSlug) return;
            const note = notesTextarea.value.trim();
            const success = await saveNote(currentNoteSlug, note);

            if (success) {
                notes[currentNoteSlug] = note;
                // Update or add/remove indicator
                const link = document.querySelector(`a[data-formatted="${currentNoteSlug}"]`);
                if (link) {
                    let indicator = link.querySelector('.note-indicator');
                    if (note) {
                        if (!indicator) {
                            indicator = document.createElement('span');
                            indicator.className = 'note-indicator';
                            link.appendChild(indicator);
                        }
                        link.title = note;
                    } else {
                        if (indicator) indicator.remove();
                        link.title = '';
                    }
                }
            }

            notesPopup.style.display = 'none';
            currentNoteSlug = null;
        });

        document.addEventListener('click', (e) => {
            if (!notesPopup.contains(e.target) && notesPopup.style.display === 'block') {
                notesPopup.style.display = 'none';
                currentNoteSlug = null;
            }
        });

        // ============================================
        // INITIALIZATION
        // ============================================

        async function init() {
            // Check if Supabase is configured
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                grid.innerHTML = `
                    <div class="error">
                        <h3>Supabase Not Configured</h3>
                        <p>Edit this file and replace:</p>
                        <code>SUPABASE_URL</code> and <code>SUPABASE_ANON_KEY</code>
                        <p>with your Supabase project credentials.</p>
                        <p style="margin-top: 20px; color: #666;">
                            Get these from: Supabase Dashboard ‚Üí Settings ‚Üí API
                        </p>
                    </div>
                `;
                return;
            }

            try {
                // First, try to migrate any existing localStorage data
                await migrateFromLocalStorage();

                // Load companies from Supabase
                companyData = await loadCompanies();

                if (companyData.length === 0) {
                    grid.innerHTML = `
                        <div class="empty">
                            <h3>No companies in database</h3>
                            <p>Import your ashby-valid.csv file using the button above.</p>
                        </div>
                    `;
                    return;
                }

                generateGrid();

            } catch (error) {
                console.error('Init error:', error);
                grid.innerHTML = `
                    <div class="error">
                        <h3>Connection Error</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px; color: #666;">Check your Supabase credentials and try again.</p>
                    </div>
                `;
            }
        }

        // App is started by showApp() after successful login
    </script>
</body>
</html>
